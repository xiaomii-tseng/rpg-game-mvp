<div class="combat-container">

  <app-damage-text *ngFor="let text of floatingTexts()" [value]="text.value" [type]="text.type" [x]="text.x"
    [y]="text.y">
  </app-damage-text>

  <!-- é¡¯ç¤ºé—œå¡æ•¸ -->
  <div class="stage-info" style="text-align: center; color: #f39c12; font-weight: bold; margin-bottom: 5px;">
    ğŸ Stage: {{ combat.currentStage() }} / {{ combat.maxStage }}
    (â­ {{ combat.mapDifficulty() }})
  </div>

  <!-- æ€ªç‰©å€åŸŸ -->
  <div class="unit-area enemy-area">
    <h2>Lv.{{ combat.enemy().level }} {{ combat.enemy().name }}</h2>
    <div *ngIf="combat.enemy().isCharging && !combat.enemy().isDead" class="status-text charging">
      ğŸ”¥ è“„åŠ›ä¸­ (æº–å‚™é‡‹æ”¾å¿…æ®ºæŠ€ï¼) ğŸ”¥
    </div>
    <div class="bar-container">
      <div class="hp-bar" [style.width.%]="(combat.enemy().hp / combat.enemy().maxHp) * 100"></div>
      <span class="text">{{ combat.enemy().hp }} / {{ combat.enemy().maxHp }}</span>
    </div>

    <div class="bar-container shield-container">
      <div class="shield-bar" [class.broken]="combat.enemy().isBroken"
        [style.width.%]="(combat.enemy().shield / combat.enemy().maxShield) * 100">
      </div>
      <span class="text">Shield: {{ combat.enemy().shield }}</span>
    </div>

    <div *ngIf="combat.enemy().isBroken && !combat.enemy().isDead" class="status-text">âš ï¸ BREAK âš ï¸</div>
  </div>

  <!-- æˆ°é¬¥è³‡è¨Š -->
  <div class="log-area">
    <div *ngFor="let log of combat.battleLog().slice().reverse()">
      {{ log }}
    </div>
  </div>

  <!-- ç©å®¶å€åŸŸ -->
  <div class="unit-area player-area">
    <h3>Lv.{{ combat.player().level }} {{ combat.player().name }}</h3>

    <div class="player-stats">
      ğŸ’ª ç¸½æ”»æ“ŠåŠ›ï¼š
      <span class="highlight">
        {{ combat.player().stats.minAtk }} - {{ combat.player().stats.maxAtk }}
      </span>
    </div>

    <div class="equipment-slot" [class.empty]="!combat.player().equipment.weapon">
      <span>âœ‹ ä¸»æ‰‹ï¼š</span>
      <span *ngIf="combat.player().equipment.weapon; else noWeapon">
        {{ combat.player().equipment.weapon?.name }}
        <span class="weapon-stat">(æ•¸å€¼: {{ combat.player().equipment.weapon?.stats?.minAtk }}-{{
          combat.player().equipment.weapon?.stats?.maxAtk }})</span>
      </span>
      <ng-template #noWeapon><span class="empty-text">ç©ºæ‰‹</span></ng-template>
    </div>

    <div class="bar-container">
      <div class="hp-bar" [style.width.%]="(combat.player().hp / combat.player().maxHp) * 100"></div>
      <span class="text">{{ combat.player().hp }} / {{ combat.player().maxHp }}</span>
    </div>

    <div class="bar-container mp-container">
      <div class="mp-bar" [style.width.%]="(combat.player().mp / combat.player().maxMp) * 100"></div>
      <span class="text">{{ combat.player().mp }} / {{ combat.player().maxMp }}</span>
    </div>

    <div class="bar-container xp-container">
      <div class="xp-bar" [style.width.%]="(combat.player().xp / (combat.player().level * 100)) * 100">
      </div>
      <span class="text">XP: {{ combat.player().xp }} / {{ combat.player().level * 100 }}</span>
    </div>

    <div class="actions">

      <div class="combat-btns">
        <button (click)="onPlayerAttack()"
          [disabled]="combat.enemy().isDead || combat.player().isDead || !combat.isPlayerTurn()">
          ğŸ—¡ï¸ æ™®æ”»
        </button>

        <button (click)="combat.playerGuard()" class="guard-btn"
          [disabled]="combat.enemy().isDead || combat.player().isDead || !combat.isPlayerTurn()">
          ğŸ›¡ï¸ æ ¼æ“‹
        </button>

        <button (click)="combat.playerSkill()" class="skill-btn"
          [disabled]="combat.enemy().isDead || combat.player().isDead || !combat.isPlayerTurn() || combat.player().mp < 20">
          ğŸ”¥ é‡æ“Š
        </button>
      </div>

      <button (click)="combat.resetBattle()" class="reset-btn">
        <ng-container *ngIf="combat.enemy().isDead; else resetText">
          â¡ï¸ ä¸‹ä¸€å ´æˆ°é¬¥ (Next Battle)
        </ng-container>
        <ng-template #resetText>
          ğŸ”„ é‡ç½®æˆ°é¬¥ (Reset)
        </ng-template>
      </button>
    </div>
  </div>

  <!-- èƒŒåŒ… -->
  <div class="inventory-area" *ngIf="combat.player().inventory.length > 0">
    <h4>ğŸ’ èƒŒåŒ… ({{ combat.player().inventory.length }})
      <span style="font-size: 0.8em; color: #2ecc71; margin-left: 10px;">
        è—¥æ°´: {{ getPotionCount() }} / 3
      </span>
    </h4>
    <div class="item-list">
      <div *ngFor="let item of combat.player().inventory" class="item-card clickable" [class]="item.rarity"
        (click)="combat.useItem(item)">
        <span class="item-name">{{ item.name }}</span>
        <span class="item-stat" *ngIf="item.stats?.minAtk">
          âš”ï¸ {{ item.stats?.minAtk }} - {{ item.stats?.maxAtk }}
        </span>
        <span class="item-stat heal" *ngIf="item.stats?.hp">
          ğŸ’š +{{ item.stats?.hp }}
        </span>
        <span class="item-stat mana" *ngIf="item.stats?.mp">
          ğŸ’™ +{{ item.stats?.mp }}
        </span>
      </div>
    </div>
  </div>

  <!-- åˆªæª”æŒ‰éˆ• -->
  <div style="margin-top: 20px; text-align: center;">
    <button (click)="combat.hardReset()" style="background: #c0392b; font-size: 12px; padding: 5px;">
      ğŸ—‘ï¸ åˆªé™¤å­˜æª”é‡ä¾† (Hard Reset)
    </button>
  </div>
</div>